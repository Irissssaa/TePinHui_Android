## 特品汇 Android 前端补齐开发报告（张圯炫）

> 用于期末汇报梳理整套逻辑：**后端数据与接口 → 前端页面与交互 → 关键问题与修复 → 验收脚本与演示顺序**。  
> 代码以 `TePinHui_Android` 工程为准；接口契约以 `TePinHui_Backend/开发日志/API_CONTRACT.md` 为准。

---

## 一、整体架构与工程分层

### 1) 技术栈
- **Android**：Activity / Fragment + RecyclerView
- **网络请求**：OkHttp + Gson（统一封装在 `NetworkUtils`）
- **图片加载**：Glide（商品主图 / 故事封面 / 帖子图片 / 头像）
- **数据结构**：`Result<T>` 统一响应 + DTO 对齐后端字段

### 2) 代码分层（汇报要点：职责清晰）
- **UI 页面层**：`app/src/main/java/com/example/tepinhui/ui/**`
- **网络层**：`app/src/main/java/com/example/tepinhui/NetworkUtils.java`
  - 统一 `get/post` 方法
  - 支持 `TypeToken` 泛型反序列化
  - 支持携带 `Authorization: Bearer <token>`
- **API Service（可选封装）**：`app/src/main/java/com/example/tepinhui/network/*ApiService.java`
  - 例如 `UserApiService.getToken(context)` 统一从 SharedPreferences 取 token
- **DTO**：`app/src/main/java/com/example/tepinhui/dto/**`

### 3) Base URL（联调最关键点）
文件：`TePinHui_Android/app/src/main/java/com/example/tepinhui/NetworkUtils.java`
- **真机联调**：`BASE_URL` 必须改为后端部署机器的 IP（同网段可达）
- **模拟器联调**：通常使用 `http://10.0.2.2:8080`
- Manifest 允许 HTTP：`android:usesCleartextTraffic="true"`

---

## 二、页面入口与路由（从 Manifest 到用户路径）

文件：`TePinHui_Android/app/src/main/AndroidManifest.xml`
- **主界面**：`MainActivity`（底部导航容器）
- **登录/注册**：`LoginActivity`、`RegisterActivity`
- **商品链路**：`ProductDetailActivity`
- **分类页**：`CategoryActivity`
- **故事链路**：`StoryListActivity`、`StoryDetailActivity`
- **社区链路**：`PostPublishActivity`、`PostDetailActivity`、`HelpDetailActivity`

> 汇报建议：按“用户使用路径”讲——登录 → 首页看商品 → 分类筛选 → 商品详情/故事 → 社区发帖/评论/点赞。

---

## 三、商品模块：首页 / 分类 / 详情 / 故事（完整闭环）

### 1) 首页 Home（Banner + 商品列表 + 快捷入口）
**页面类**：`ui/home/HomeFragment.java`

**接口对接**
- `GET /api/banners`：Banner 列表
- `GET /api/products?page=1&size=10`：首页商品列表

**数据流**
- `loadBanners()` → `NetworkUtils.get("/api/banners")` → `BannerAdapter` 刷新
- `loadProducts()` → `NetworkUtils.get("/api/products?...")` → `ProductAdapter` 刷新

**入口**
- 分类：跳转 `CategoryActivity`
- 故事：跳转 `StoryListActivity`
- 搜索：跳转 `SearchActivity`（已实现真实搜索：请求 `/api/products?keyword=...`，展示结果与空态）

---

### 2) 分类 Category（按地区/按品类：双维度筛选）
**页面类**：`ui/category/CategoryActivity.java`

**背景问题（为什么要补齐）**
- 早期只展示静态“省份/分类”，点击后仍请求全量商品，导致“点哪个都一样/省份混乱”。
- 现在改为：先拉后端标准化维度（地区/品类带 id），再把 `regionId/categoryId` 作为参数请求商品列表，实现 **SQL 层过滤**。

**接口对接**
- `GET /api/regions`：地区列表（RegionDTO：`id/name`）
- `GET /api/categories`：品类列表（CategoryDTO：`id/name`）
- `GET /api/products?page=1&size=20&regionId=?&categoryId=?`：筛选商品（参数可空）

**关键实现点**
- 左侧列表在两种模式切换：`isRegionMode`
- 左侧点击项：
  - 地区模式：name → regionId → `loadProducts(regionId, null)`
  - 品类模式：name → categoryId → `loadProducts(null, categoryId)`
- 兜底策略：接口失败时仍显示静态列表（保证演示不崩）

---

### 3) 商品详情 ProductDetail（内容化字段 + 加入购物车 + 进入故事）
**页面类**：`ui/product/ProductDetailActivity.java`

**接口对接**
- `GET /api/products/{id}`：详情（含 `shortIntro/cultureNote/storyId` 等内容化字段）
- `POST /api/cart/items`：加入购物车（需登录 token）

**关键交互**
- **加入购物车**：点击按钮 → token 校验 → POST `/api/cart/items`
- **特产故事入口（补齐项）**：
  - 若 `storyId != null`：显示入口并可点击
  - 点击后跳转 `StoryDetailActivity` 并传 `storyId`

---

### 4) 故事 Stories（列表 + 详情 + 关联商品）
**页面类**
- `ui/story/StoryListActivity.java`
- `ui/story/StoryDetailActivity.java`

**接口对接**
- `GET /api/stories`：故事列表（`id/title/coverUrl`）
- `GET /api/stories/{id}`：故事详情（`title/content/coverUrl + products[]`）

**闭环**
- 商品详情 → 故事详情（storyId）
- 故事详情 → 相关商品横向列表 → 商品详情（形成“内容化”闭环，满足“文化故事”卖点）

---

## 四、社区模块：帖子列表 / 发帖 / 详情 / 评论回复 / 点赞 / 图片与头像

### 1) 三个板块（热门/推荐/互助）必须数据隔离
**页面类**
- `ui/community/HotFragment.java`
- `ui/community/RecommendFragment.java`
- `ui/community/HelpFragment.java`

**接口对接**
- `GET /api/community/posts?source=HOT|RECOMMEND|HELP&page=1&size=10`

**验收点（期末必讲）**
- 三个 tab 的帖子必须不同：通过 `source` 参数实现隔离
- `onResume()` 自动刷新：发帖/点赞/评论返回后，计数与列表能立即更新

---

### 2) 发帖 PostPublish（对齐后端入参）
**页面类**：`ui/community/PostPublishActivity.java`

**接口对接**
- `POST /api/community/posts`
- body：`{ content, images, source }`
- ✅ 已补齐发帖图片：先上传图片得到 URL 列表，再发帖携带 `images[]`
- `POST /api/upload`（multipart 上传，字段名 `file`，返回 `Result<String>`，data 为图片 URL）

**交互细节**
- 未登录不允许发帖（token 校验）
- 防连点：请求期间禁用按钮
- 成功后 `finish()` 返回列表页；列表页 `onResume()` 自动刷新

**图片选择/预览/上传流程（期末可直接照着讲）**
- 选图：点击“📷 添加图片（最多 9 张）”，系统相册多选（`GetMultipleContents("image/*")`）
- 预览：下方 3 列网格预览已选图片，可点击 “×” 删除某张
- 发布：
  - 若未选图：直接请求 `POST /api/community/posts`
  - 若已选图：逐张上传 `POST /api/upload` → 拿到 URL 列表 → 再请求 `POST /api/community/posts`，body.images = URL 数组
- 文件与组件：
  - 布局：`res/layout/activity_post_publish.xml`、`res/layout/item_selected_image.xml`
  - 适配器：`ui/community/SelectedImageAdapter.java`
  - 上传封装：`NetworkUtils.uploadImage(...)`（multipart）

---

### 3) 帖子详情 PostDetail（详情 + 评论列表 + 回复楼中楼 + 点赞）
**页面类**：`ui/community/PostDetailActivity.java`

**接口对接**
- `GET /api/community/posts/{postId}`：刷新帖子详情（likeCount/commentCount/图片等）
- `GET /api/community/posts/{postId}/comments`：评论列表（`parentId + replyToUser`）
- `POST /api/community/posts/{postId}/comments`：发评论/发回复（`{ content, parentId }`）
- `POST /api/community/posts/{postId}/like`：帖子点赞（需登录）
- `POST /api/community/comments/{commentId}/like`：评论点赞（需登录）

**UI 组织方式**
- 采用 `ConcatAdapter`：
  - Header：`PostHeaderAdapter`（作者、正文、配图、赞数、评论数）
  - 评论列表：`CommentAdapter`
- 优点：header 与评论同一个 RecyclerView，滚动自然

**回复（楼中楼）**
- 点击某条评论：进入“回复模式”
  - 记录 `replyParentId` + `replyToUser`
  - 输入框提示变为 `回复 @xxx`
- 发送成功后：清空输入、退出回复模式、刷新帖子详情与评论列表

**点赞（补齐项）**
- 帖子点赞：点击 header 的“赞 X”
  - 先做乐观 +1，再请求后端
  - 若失败则回拉详情纠正
- 评论点赞：长按评论（避免占用“点击=回复”）
  - 先做乐观 +1，再请求后端
  - 若失败则回拉评论列表纠正

---

### 4) 头像与图片加载策略（可讲“无后端头像也能演示”）
**头像**
- DTO 支持 `avatarUrl`；后端当前可能返回 `null`
- 前端兜底：`AvatarUtil.forUser(userName)` 实现“随机但固定”的本地头像
- 渲染优先级：
  1) `avatarUrl` 非空 → Glide 网络加载
  2) 否则 → 本地头像资源 id

**帖子图片**
- DTO 支持 `images: List<String>`
- 当前 UI 先展示第一张（后续可扩展九宫格）

---

## 五、关键问题与修复记录（用于答辩问答）

### 1) “点哪个分类都一样 / 省份混乱”
- 原因：前端没传 `regionId/categoryId`，只拉全量商品
- 修复：`CategoryActivity` 先拉 `regions/categories`，再带 id 请求 `/api/products?...&regionId=&categoryId=`

### 2) 社区板块串台 / 评论串台
- 原因：请求未按 `source/postId` 隔离
- 修复：列表按 `source` 拉；评论按 `/posts/{postId}/comments` 拉

### 3) 点赞只在本地变化
- 原因：UI 层没有接点赞接口
  - 修复：帖子点赞对接 `POST /api/community/posts/{postId}/like`；评论点赞对接 `POST /api/community/comments/{commentId}/like`

### 4) 购物车接口不通（前端已做，但后端缺口）
- 现状：前端已调用
  - `GET /api/cart`（购物车页）
  - `POST /api/cart/items`（商品详情“加入购物车”）
- 修复：后端已补齐并兼容（无需改前端），确保演示可用

### 5) 收藏/足迹/消息部分接口路径不一致
- 现状：前端存在兼容写法（如 `GET .../delete`、`batch-delete`、`check`、`batch-read`）
- 修复：后端已补齐所有缺口接口，前端无需改动即可跑通

### 6) 社区加载慢导致“看起来没数据”
- 现象：后端响应慢时，前端 10s 超时 → 列表页空白（尤其 Hot/Recommend 之前吞掉 onError）
- 处理：本地调试已加入超时放宽与更小分页 size 的兜底，并在列表页提示错误原因
- 说明：该优化属于“体验增强”，如需合入主分支再统一处理冲突与合并策略
- 修复：对齐后端：
  - 帖子点赞：`POST /api/community/posts/{postId}/like`
  - 评论点赞：`POST /api/community/comments/{commentId}/like`

---

## 六、期末演示脚本（建议顺序）

### 1) 演示前准备
- 后端服务可访问（同网段可达）
- `NetworkUtils.BASE_URL` 已改为当前后端地址

### 2) 演示流程（10~15 分钟版本）
- 登录/注册 → 进入主界面
- 首页：Banner + 商品列表加载正常
- 分类：切换“按地区/按品类”，点击左侧项，右侧商品变化（证明 SQL 过滤）
- 商品详情：内容化字段展示；加入购物车；若有故事可跳故事详情
- 故事：列表 → 详情 → 相关商品（闭环）
- 社区：
  - 三个板块内容不同（HOT/RECOMMEND/HELP）
  - 发帖 → 返回立即刷新
  - 进入帖子详情：评论/回复楼中楼/点赞（帖子&评论）

---

## 七、APK 打包

在 `TePinHui_Android` 目录执行：
```bash
.\gradlew.bat assembleDebug
```
输出：`app/build/outputs/apk/debug/app-debug.apk`


